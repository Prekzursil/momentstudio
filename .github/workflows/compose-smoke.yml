name: Docker Compose Smoke

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  compose-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Upgrade npm
        run: npm i -g npm@11.7.0

      - name: Install frontend deps (for Playwright)
        run: |
          cd frontend
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 npm ci
          npx playwright install --with-deps chromium firefox

      - name: Build and start stack
        env:
          LOCKERS_USE_OVERPASS_FALLBACK: '0'
          PAYMENTS_PROVIDER: 'mock'
        run: |
          docker compose -f infra/docker-compose.yml up -d --build

      - name: Smoke test (frontend + backend health)
        run: |
          set -euo pipefail

          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8001/api/v1/health/ready >/dev/null; then
              echo "Backend is ready"
              break
            fi
            echo "Waiting for backend readiness... ($i/60)"
            sleep 2
          done
          curl -fsS http://localhost:8001/api/v1/health
          curl -fsS http://localhost:8001/api/v1/health/ready

          for i in $(seq 1 60); do
            if curl -fsS http://localhost:4201 >/dev/null; then
              echo "Frontend is up"
              break
            fi
            echo "Waiting for frontend... ($i/60)"
            sleep 2
          done
          curl -fsS http://localhost:4201 >/dev/null

          manifest_headers="$(mktemp)"
          curl -fsSI http://localhost:4201/manifest.webmanifest > "$manifest_headers"
          manifest_mime="$(
            awk -F': *' 'tolower($1) == "content-type" { print tolower($2) }' "$manifest_headers" \
              | tr -d '\r' \
              | head -n 1
          )"
          if [[ "${manifest_mime}" != application/manifest+json* ]]; then
            echo "Unexpected manifest content-type: ${manifest_mime:-<missing>}" >&2
            exit 1
          fi

          headers_file="$(mktemp)"
          curl -fsSI http://localhost:4201/ > "$headers_file"
          for header in content-security-policy permissions-policy referrer-policy x-frame-options x-content-type-options; do
            count="$(grep -i -c "^${header}:" "$headers_file" || true)"
            if [[ "$count" -gt 1 ]]; then
              echo "Duplicate header '${header}' detected (${count})" >&2
              exit 1
            fi
          done

          home_html="$(mktemp)"
          curl -fsS http://localhost:4201/ > "$home_html"
          bundle_path="$(
            grep -Eo "/[^\"[:space:]]+\.[0-9a-f]{8,}\.js" "$home_html" \
              | head -n 1 \
              || true
          )"
          if [[ -z "${bundle_path}" ]]; then
            echo "Unable to find hashed JS bundle in homepage HTML" >&2
            exit 1
          fi

          bundle_headers="$(mktemp)"
          curl -fsSI "http://localhost:4201${bundle_path}" > "$bundle_headers"
          bundle_cache="$(
            awk -F': *' 'tolower($1) == "cache-control" { print tolower($2) }' "$bundle_headers" \
              | tr -d '\r' \
              | head -n 1
          )"
          if [[ "${bundle_cache}" != *immutable* ]]; then
            echo "Unexpected bundle cache-control: ${bundle_cache:-<missing>}" >&2
            exit 1
          fi

          app_config_headers="$(mktemp)"
          curl -fsSI http://localhost:4201/assets/app-config.js > "$app_config_headers"
          app_config_cache="$(
            awk -F': *' 'tolower($1) == "cache-control" { print tolower($2) }' "$app_config_headers" \
              | tr -d '\r' \
              | head -n 1
          )"
          if [[ "${app_config_cache}" != *no-store* ]]; then
            echo "Unexpected app-config cache-control: ${app_config_cache:-<missing>}" >&2
            exit 1
          fi

      - name: Generate E2E owner credentials
        run: |
          set -euo pipefail
          echo "E2E_OWNER_IDENTIFIER=owner" >> "$GITHUB_ENV"
          echo "E2E_OWNER_EMAIL=owner@example.com" >> "$GITHUB_ENV"
          pw="$(openssl rand -hex 16)"
          echo "::add-mask::$pw"
          echo "E2E_OWNER_PASSWORD=$pw" >> "$GITHUB_ENV"

      - name: Prepare DB (migrations + seeds + owner)
        run: |
          set -euo pipefail
          docker compose -f infra/docker-compose.yml exec -T backend alembic upgrade head
          docker compose -f infra/docker-compose.yml exec -T backend python -m app.seeds
          docker compose -f infra/docker-compose.yml exec -T backend python -m app.cli bootstrap-owner --email "$E2E_OWNER_EMAIL" --password "$E2E_OWNER_PASSWORD" --username "$E2E_OWNER_IDENTIFIER" --display-name Owner

      - name: Playwright E2E (payments, chromium)
        run: |
          cd frontend
          E2E_BASE_URL=http://localhost:4201 E2E_OWNER_IDENTIFIER="$E2E_OWNER_IDENTIFIER" E2E_OWNER_PASSWORD="$E2E_OWNER_PASSWORD" npm run e2e -- e2e/checkout-stripe.spec.ts e2e/checkout-paypal.spec.ts --workers=1 --project=chromium

      - name: Playwright E2E (smoke)
        run: |
          cd frontend
          # Keep the PR gate fast and stable: run only the smoke suite here.
          # Full E2E coverage can be run via `npm run e2e` locally or in a separate workflow.
          E2E_BASE_URL=http://localhost:4201 E2E_OWNER_IDENTIFIER="$E2E_OWNER_IDENTIFIER" E2E_OWNER_PASSWORD="$E2E_OWNER_PASSWORD" npm run e2e -- e2e/smoke.spec.ts --workers=1

      - name: Playwright E2E (SEO crawl guard, chromium)
        run: |
          cd frontend
          E2E_BASE_URL=http://localhost:4201 npm run e2e -- e2e/seo-public-routes.spec.ts --workers=1 --project=chromium

      - name: Playwright E2E (admin freeze guard, firefox)
        run: |
          cd frontend
          E2E_BASE_URL=http://localhost:4201 E2E_OWNER_IDENTIFIER="$E2E_OWNER_IDENTIFIER" E2E_OWNER_PASSWORD="$E2E_OWNER_PASSWORD" npm run e2e -- e2e/admin-dashboard-freeze.spec.ts --workers=1 --project=firefox

      - name: Logs (on failure)
        if: failure()
        run: |
          docker compose -f infra/docker-compose.yml ps
          docker compose -f infra/docker-compose.yml logs --no-color

      - name: Tear down
        if: always()
        run: |
          docker compose -f infra/docker-compose.yml down -v
