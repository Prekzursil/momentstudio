name: Applitools Visual

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: "30 6 * * 2"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  applitools-core:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Upgrade npm
        run: npm i -g npm@11.7.0

      - name: Resolve Applitools key availability
        id: applitools
        env:
          APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
        run: |
          if [ -n "${APPLITOOLS_API_KEY:-}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            {
              echo "## Applitools Visual"
              echo ""
              echo "Skipped: \`APPLITOOLS_API_KEY\` is not configured."
            } >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Install frontend dependencies
        if: steps.applitools.outputs.enabled == 'true'
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: Build and start compose stack
        if: steps.applitools.outputs.enabled == 'true'
        env:
          LOCKERS_USE_OVERPASS_FALLBACK: "0"
          PAYMENTS_PROVIDER: "mock"
        run: docker compose -f infra/docker-compose.yml up -d --build

      - name: Wait for frontend/backend
        if: steps.applitools.outputs.enabled == 'true'
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:8001/api/v1/health/ready >/dev/null; then
              break
            fi
            sleep 2
          done
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:4201 >/dev/null; then
              break
            fi
            sleep 2
          done
          curl -fsS http://localhost:4201 >/dev/null

      - name: Applitools Eyes snapshot run (non-blocking)
        if: steps.applitools.outputs.enabled == 'true'
        env:
          APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
          APPLITOOLS_BATCH_NAME: GitHub-${{ github.workflow }}-${{ github.ref_name }}
          E2E_BASE_URL: http://localhost:4201
        run: |
          set +e
          cd frontend
          npm run e2e -- --project=chromium e2e/applitools-core-routes.spec.ts
          status=$?
          if [ "$status" -eq 0 ]; then
            {
              echo "## Applitools Visual"
              echo ""
              echo "Eyes snapshot run completed."
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "## Applitools Visual"
              echo ""
              echo "Eyes snapshot run reported failures (non-blocking)."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
          exit 0

      - name: Logs (on failure)
        if: failure() && steps.applitools.outputs.enabled == 'true'
        run: docker compose -f infra/docker-compose.yml logs --no-color --tail=200

      - name: Tear down
        if: always() && steps.applitools.outputs.enabled == 'true'
        run: docker compose -f infra/docker-compose.yml down -v
