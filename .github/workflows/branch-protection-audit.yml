name: Branch Protection Audit

on:
  workflow_dispatch:
  schedule:
    - cron: '30 6 * * 1'

permissions:
  contents: read
  issues: write

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Audit main branch protection
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = "main";
            const findings = [];

            let protection;
            try {
              protection = await github.rest.repos.getBranchProtection({ owner, repo, branch });
            } catch (error) {
              findings.push(`Branch protection missing or inaccessible for ${branch}: ${error.message}`);
            }

            if (protection?.data) {
              const reviews = protection.data.required_pull_request_reviews;
              const checks = protection.data.required_status_checks;

              if (!reviews || (reviews.required_approving_review_count ?? 0) < 1) {
                findings.push("Required approving review count is below 1.");
              }

              if (!checks) {
                findings.push("Required status checks are not configured.");
              }
            }

            if (findings.length === 0) {
              core.info("Branch protection audit passed.");
              return;
            }

            const title = `Branch protection audit findings - ${new Date().toISOString().slice(0, 10)}`;
            const body = [
              "## Findings",
              ...findings.map(f => `- ${f}`),
              "",
              "## Required action",
              "- Update branch protection to meet Phase-3/4 policy baseline.",
            ].join("\n");

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ["area:security", "risk:medium"],
            });
