{
	# Optional: set in infra/prod/.env (CADDY_EMAIL=...)
	email {$CADDY_EMAIL}
}

# Redirect www -> apex to keep a single canonical origin (payments + localStorage).
www.{$PUBLIC_DOMAIN} {
	redir https://{$PUBLIC_DOMAIN}{uri} permanent
}

# momentstudio.ro (production)
{$PUBLIC_DOMAIN} {
	encode zstd gzip

	@api path /api/*
	handle @api {
		reverse_proxy backend:8000
	}

	@media_private path /media/private/*
	handle @media_private {
		respond "Not Found" 404
	}

	@media path /media/*
	handle @media {
		header Cache-Control "public, max-age=2592000, immutable"
		reverse_proxy backend:8000
	}

	@robots path /robots.txt
	handle @robots {
		rewrite * /api/v1/robots.txt
		reverse_proxy backend:8000
	}

	@sitemap path /sitemap.xml
	handle @sitemap {
		rewrite * /api/v1/sitemap.xml
		reverse_proxy backend:8000
	}

	# Everything else is served by the SSR frontend runtime.
	handle {
			header {
				Referrer-Policy "no-referrer"
				X-Content-Type-Options "nosniff"
				X-Frame-Options "DENY"
				Permissions-Policy "geolocation=(self), microphone=(), camera=()"
				# Angular CLI emits `onload="this.media='all'"` for the main stylesheet. CSP hashes don't
				# apply to event handlers unless `unsafe-hashes` is present, so allow only this handler
				# without enabling `unsafe-inline`.
				Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; script-src 'self' https://challenges.cloudflare.com https://www.clarity.ms 'unsafe-hashes' 'sha256-MhtPZXr7+LpJUY5qtMutB+qWfQtMaPccfe7QXtCcEYc='; connect-src 'self' https://www.clarity.ms https://c.clarity.ms https:; frame-src https://challenges.cloudflare.com; manifest-src 'self'; font-src 'self' data:;"
			}
		reverse_proxy frontend-ssr:4000
	}
}
