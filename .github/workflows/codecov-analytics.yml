name: Codecov Analytics

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  codecov-analytics:
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Validate Codecov token
        run: |
          if [ -z "${CODECOV_TOKEN}" ]; then
            echo "::error::Missing CODECOV_TOKEN secret. Configure it in GitHub Actions secrets."
            exit 1
          fi

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-ci.txt

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-ci.txt

      - name: Run backend tests with coverage + junit
        id: backend_tests
        continue-on-error: true
        run: |
          set +e
          mkdir -p backend/test-results
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          coverage run --source=backend/app -m pytest backend/tests --junitxml=backend/test-results/pytest.junit.xml
          test_exit=$?
          coverage xml -o backend/coverage.xml
          coverage_exit=$?
          echo "test_exit_code=$test_exit" >> "$GITHUB_OUTPUT"
          echo "coverage_exit_code=$coverage_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Chrome
        id: chrome
        uses: browser-actions/setup-chrome@c785b87e244131f27c9f19c1a33e2ead956ab7ce # v1

      - name: Install frontend dependencies
        run: |
          cd frontend
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 npm ci

      - name: Run frontend tests with coverage + junit
        id: frontend_tests
        continue-on-error: true
        run: |
          set +e
          cd frontend
          mkdir -p test-results
          export CHROME_BIN="${{ steps.chrome.outputs.chrome-path }}"
          export KARMA_JUNIT=1
          npm test -- --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage
          test_exit=$?
          if [ "$test_exit" -ne 0 ]; then
            npm test -- --watch=false --code-coverage
            test_exit=$?
          fi
          cd ..
          echo "test_exit_code=$test_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build frontend browser bundle
        id: frontend_build
        continue-on-error: true
        run: |
          set +e
          cd frontend
          npm run build
          build_exit=$?
          cd ..
          echo "build_exit_code=$build_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload coverage reports to Codecov
        id: upload_coverage
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: backend/coverage.xml,frontend/coverage/**/lcov.info
          flags: backend,frontend
          fail_ci_if_error: false
          verbose: true

      - name: Upload test results to Codecov
        id: upload_test_results
        if: ${{ !cancelled() }}
        continue-on-error: true
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # v1.2.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: backend/test-results/pytest.junit.xml,frontend/test-results/karma.junit.xml
          disable_search: true
          fail_ci_if_error: false
          verbose: true

      - name: Upload browser bundle analysis to Codecov
        id: browser_bundle
        if: ${{ !cancelled() && steps.frontend_build.outputs.build_exit_code == '0' }}
        continue-on-error: true
        run: |
          set +e
          if [ ! -d frontend/dist/app/browser ]; then
            echo "bundle_exit_code=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          npx --yes --package @codecov/bundle-analyzer bundle-analyzer ./frontend/dist/app/browser \
            --bundle-name=adrianaart-frontend-browser \
            --upload-token="${CODECOV_TOKEN}"
          bundle_exit=$?
          echo "bundle_exit_code=$bundle_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build and upload SSR bundle analysis to Codecov
        id: ssr_bundle
        if: ${{ !cancelled() && steps.frontend_build.outputs.build_exit_code == '0' }}
        continue-on-error: true
        run: |
          set +e
          cd frontend
          npm run build:ssr
          ssr_build_exit=$?
          cd ..
          if [ "$ssr_build_exit" -eq 0 ] && [ -d frontend/dist/app/server ]; then
            npx --yes --package @codecov/bundle-analyzer bundle-analyzer ./frontend/dist/app/server \
              --bundle-name=adrianaart-frontend-server \
              --upload-token="${CODECOV_TOKEN}"
            ssr_bundle_exit=$?
          else
            ssr_bundle_exit=$ssr_build_exit
          fi
          echo "bundle_exit_code=$ssr_bundle_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Enforce test/build and bundle results
        if: ${{ !cancelled() }}
        run: |
          fail=0

          if [ "${{ steps.backend_tests.outputs.test_exit_code }}" != "0" ]; then
            echo "::error::Backend tests failed (exit ${{ steps.backend_tests.outputs.test_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.backend_tests.outputs.coverage_exit_code }}" != "0" ]; then
            echo "::error::Backend coverage export failed (exit ${{ steps.backend_tests.outputs.coverage_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.frontend_tests.outputs.test_exit_code }}" != "0" ]; then
            echo "::error::Frontend tests failed (exit ${{ steps.frontend_tests.outputs.test_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.frontend_build.outputs.build_exit_code }}" != "0" ]; then
            echo "::error::Frontend browser build failed (exit ${{ steps.frontend_build.outputs.build_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.browser_bundle.outputs.bundle_exit_code }}" != "0" ]; then
            echo "::error::Browser bundle upload failed (exit ${{ steps.browser_bundle.outputs.bundle_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.ssr_bundle.outputs.bundle_exit_code }}" != "0" ]; then
            echo "::error::SSR bundle upload failed (exit ${{ steps.ssr_bundle.outputs.bundle_exit_code }})."
            fail=1
          fi

          if [ "${{ steps.upload_coverage.outcome }}" != "success" ]; then
            echo "::error::Codecov coverage upload step did not succeed (outcome=${{ steps.upload_coverage.outcome }})."
            fail=1
          fi

          if [ "${{ steps.upload_test_results.outcome }}" != "success" ]; then
            echo "::error::Codecov test-results upload step did not succeed (outcome=${{ steps.upload_test_results.outcome }})."
            fail=1
          fi

          exit $fail
