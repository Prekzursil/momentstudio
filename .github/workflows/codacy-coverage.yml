name: Codacy Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  coverage:
    runs-on: ubuntu-latest
    env:
      CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
      CODACY_ORGANIZATION_PROVIDER: gh
      CODACY_USERNAME: Prekzursil
      CODACY_PROJECT_NAME: AdrianaArt
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-ci.txt

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-ci.txt

      - name: Run backend tests with coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/backend
          coverage run --source=backend/app -m pytest backend/tests
          coverage xml -o backend/coverage.xml

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set up Chrome
        id: chrome
        uses: browser-actions/setup-chrome@c785b87e244131f27c9f19c1a33e2ead956ab7ce # v1

      - name: Install frontend dependencies
        run: |
          cd frontend
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1 npm ci

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          export CHROME_BIN="${{ steps.chrome.outputs.chrome-path }}"
          npm test -- --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage || npm test -- --watch=false --code-coverage

      - name: Validate Codacy token
        run: |
          if [ -z "${CODACY_API_TOKEN}" ]; then
            echo "::error::Missing CODACY_API_TOKEN secret. Configure it in GitHub Actions secrets."
            exit 1
          fi

      - name: Upload coverage reports to Codacy
        run: |
          bash <(curl -Ls https://coverage.codacy.com/get.sh) report \
            --api-token "${CODACY_API_TOKEN}" \
            --organization-provider "${CODACY_ORGANIZATION_PROVIDER}" \
            --username "${CODACY_USERNAME}" \
            --project-name "${CODACY_PROJECT_NAME}" \
            --coverage-reports backend/coverage.xml \
            --coverage-reports frontend/coverage/app/lcov.info
