name: Audit Agent Watchdog

on:
  schedule:
    - cron: "15 6 * * *"
  workflow_dispatch:

permissions: {}

jobs:
  audit-agent-watchdog:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    outputs:
      scanned: ${{ steps.watchdog.outputs.scanned }}
      stale: ${{ steps.watchdog.outputs.stale }}
      updated: ${{ steps.watchdog.outputs.updated }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run stale issue watchdog
        id: watchdog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          WATCHDOG_LOG="$(mktemp)"
          python3 scripts/audit/agent_issue_watchdog.py \
            --stale-days "5" \
            --audit-filter "audit:*" | tee "$WATCHDOG_LOG"

          scanned="$(awk -F '=' '/^scanned=/{value=$2} END{print value}' "$WATCHDOG_LOG")"
          stale="$(awk -F '=' '/^stale=/{value=$2} END{print value}' "$WATCHDOG_LOG")"
          updated="$(awk -F '=' '/^updated=/{value=$2} END{print value}' "$WATCHDOG_LOG")"

          for value in "$scanned" "$stale" "$updated"; do
            if [[ ! "$value" =~ ^[0-9]+$ ]]; then
              echo "Invalid watchdog counter output: scanned=$scanned stale=$stale updated=$updated"
              exit 1
            fi
          done

          {
            echo "scanned=$scanned"
            echo "stale=$stale"
            echo "updated=$updated"
          } >> "$GITHUB_OUTPUT"

          {
            echo "## Agent watchdog summary"
            echo
            echo "- Scanned issues: \`$scanned\`"
            echo "- Stale candidates: \`$stale\`"
            echo "- Updated issues: \`$updated\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Log watchdog counters
        run: |
          echo "scanned=${{ steps.watchdog.outputs.scanned }}"
          echo "stale=${{ steps.watchdog.outputs.stale }}"
          echo "updated=${{ steps.watchdog.outputs.updated }}"
